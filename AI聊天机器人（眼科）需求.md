# 基于提示词工程的AI聊天机器人（眼科）需求

## 定义：

1. 系统：本python项目
2. 服务器：Java服务器

## 背景：

眼科疾病已经成为继肿瘤和心脑血管疾病之后第三大威胁人类健康以及生存质量的疾病。眼科疾病患病人数随着人口老龄化正在不断增加，同时，我国医疗资源分布不均匀，高水平医院医生需要花费更多时间处理常见眼科疾病，使得医生的工作任务愈发繁重，带来的医师漏判、误诊、效率低及专业人员短缺等弊端日益显现。显然，仅依靠人类视觉系统观察发现眼底图像中的病症并保持较高正确诊断率难度较大。因此，开发一款眼科疾病智能诊断系统可有效缓解当前问题。

"基于眼底医学影像的眼科疾病智能诊断系统"，目前已经开发完成，就是上文定义中的"服务器"。现在需要开发模型对话服务，应用于用户端诊断报告的"模型问答功能"。

## 概要：

Java服务器接收到客户端的隐患报告问答请求，再请求本系统。本系统调用模型API，基于提示词工程给出智能回答，并结构化地返回给Java服务器。

## 系统输入：

输入样例：

```json
{
  "disease_name": "糖尿病视网膜病变",
  "disease_category": "视网膜疾病",
  "result": "根据眼部图像分析，患者出现轻度糖尿病视网膜病变，建议定期复查，控制血糖。",
  "remark": "患者需要定期监测血糖和眼部状况",
  "treatment_plan": {
    "treatment_detail": "每天使用人工泪液，避免长时间用眼，定期复查"
  },
  "medications": [
    {
      "medication_name": "人工泪液",
      "dosage": "每次1-2滴",
      "frequency": "每天4次",
      "side_effects": "轻微刺痛感"
    }
  ],
  "previous_conversations": [
    {
      "role": "user",
      "content": "这个病严重吗？"
    },
    {
      "role": "assistant",
      "content": "根据您的眼底检查结果，您目前处于轻度糖尿病视网膜病变阶段。这个阶段并不十分严重，但需要引起重视。糖尿病视网膜病变是一种进行性疾病，如果不加以控制，可能会逐渐发展为更严重的阶段，最终可能导致视力下降甚至失明。因此，定期复查和良好的血糖控制非常重要。"
    }
  ],
  "question": "为什么要检查血糖？"
}
```

## 系统输出：

系统支持两种输出模式：标准模式和流式模式

### 标准模式（非流式）

```json
{
  "response_id": "unique-response-id-123",
  "content": "血糖检查对于糖尿病视网膜病变患者非常重要，因为这种眼部疾病与血糖水平密切相关。高血糖会损害视网膜的血管，导致视网膜出血、水肿和缺氧，进而影响视力。通过定期检查血糖，您可以：\n\n1. 监测糖尿病控制情况\n2. 及时调整治疗方案\n3. 减缓疾病进展\n4. 预防视网膜病变恶化\n\n研究表明，良好的血糖控制可以显著降低糖尿病视网膜病变发生和发展的风险。因此，除了眼科定期随访外，血糖监测也是治疗方案中不可或缺的部分。",
  "references": [
    {
      "title": "糖尿病视网膜病变临床指南",
      "source": "中华医学会眼科学分会",
      "year": 2023
    }
  ],
  "created_at": "2025-03-01T10:15:30Z"
}
```

### 流式模式

流式输出采用 SSE (Server-Sent Events) 或类似的流式传输技术，每个数据块是一个JSON对象。

单个数据块格式：
```json
{
  "response_id": "unique-response-id-123",
  "chunk_id": 1,
  "content": "血糖检查对于糖尿病视网膜病变患者非常重要，",
  "is_complete": false
}
```

最后一个数据块包含完成标志：
```json
{
  "response_id": "unique-response-id-123", 
  "chunk_id": 12,
  "content": "因此，除了眼科定期随访外，血糖监测也是治疗方案中不可或缺的部分。",
  "is_complete": true,
  "references": [
    {
      "title": "糖尿病视网膜病变临床指南",
      "source": "中华医学会眼科学分会",
      "year": 2023
    }
  ],
  "created_at": "2025-03-01T10:15:35Z"
}
```

### 实现说明

1. **Java服务器端**:
   - 根据请求参数 `stream=true/false` 决定使用哪种响应模式
   - 流式模式下使用 SSE 或相应技术发送数据块
   - 为每个响应生成唯一的 `response_id`

2. **Python系统**:
   - 调用大模型API获取响应（支持流式）
   - 标准模式：等待完整响应后返回
   - 流式模式：实时转发模型生成的文本块

3. **客户端**:
   - 支持处理两种响应形式
   - 流式模式下提供打字机效果的即时展示
   - 标准模式下等待完整响应后显示

## 提示词工程（Prompt Engineering）

### 系统提示词（System Prompt）

系统提示词用于设置模型的行为和角色定位，在每次对话开始时作为上下文输入。

```
你是一位专业的眼科医学顾问，基于患者的眼底检查结果和相关问题提供专业咨询。
你的职责是：
1. 解释眼科检查结果和诊断的含义
2. 回答患者关于眼部疾病、治疗方案和用药的问题
3. 提供基于循证医学的专业建议
4. 使用通俗易懂的语言解释专业概念
5. 在必要时强调寻求正规医疗机构和医生进一步诊疗的重要性

注意事项：
- 保持友善、耐心和专业的态度
- 避免做出确定性的诊断，应强调这只是辅助分析
- 避免开具处方或替代医生的治疗决策
- 当无法确定答案时，坦诚承认并建议咨询专业医生
- 回答应基于提供的病历信息和眼科专业知识
- 提供信息时应尽量引用可靠的医学资源
```

### 用户输入处理模板

将用户的问题与诊断报告整合成结构化的输入：

```
根据您的眼底检查结果：
- 诊断: {{disease_name}} ({{disease_category}})
- 检查结果: {{result}}
- 备注: {{remark}}
- 治疗计划: {{treatment_plan.treatment_detail}}
- 用药信息: {{medications}}

您的问题是: {{question}}
```

### 针对不同问题类型的专项提示

#### 1. 疾病解释类问题

当患者询问关于疾病本身的问题（如"这个病是什么？"、"为什么会得这种病？"）时：

```
请针对{{disease_name}}提供以下信息：
1. 简明的疾病定义
2. 常见病因和风险因素
3. 该疾病的典型症状和体征
4. 可能的发展过程和预后
5. 该疾病与患者当前症状的关联

回答应该通俗易懂，避免过多专业术语，必要时对专业概念进行解释。同时，基于患者的具体情况（{{result}}）给出针对性说明。
```

#### 2. 治疗方案类问题

当患者询问关于治疗方案的问题（如"怎么治疗？"、"需要手术吗？"）时：

```
请基于患者的{{disease_name}}诊断结果（{{result}}）和当前建议的治疗方案（{{treatment_plan.treatment_detail}}），提供：
1. 该疾病常规治疗方法概述
2. 当前推荐治疗方案的原理和目的
3. 治疗的预期效果和时间周期
4. 治疗过程中的注意事项
5. 何时应该随访或复查

强调治疗方案的重要性，但避免替代医生的临床决策，建议患者遵循专业医生的具体指导。
```

#### 3. 用药咨询类问题

当患者询问关于药物的问题（如"这个药有什么作用？"、"会有副作用吗？"）时：

```
针对患者使用的药物（{{medications}}），请提供：
1. 药物的主要作用机制
2. 正确的使用方法和频率
3. 常见副作用及其处理方法
4. 特殊注意事项（如禁忌症、药物相互作用）
5. 用药依从性的重要性

同时，根据患者的具体情况（{{disease_name}}和{{result}}），解释为何医生选择这种药物治疗。
```

#### 4. 预防和生活方式类问题

当患者询问关于预防和生活方式的问题（如"日常生活中应该注意什么？"、"如何预防病情加重？"）时：

```
针对{{disease_name}}，请提供以下生活方式和预防建议：
1. 日常护眼和自我监测方法
2. 饮食建议和营养补充
3. 适宜和不适宜的活动
4. 环境因素控制（如光线、屏幕使用等）
5. 定期随访和检查的时间表

这些建议应结合患者的具体情况（{{result}}和{{remark}}），着重强调对疾病管理特别重要的生活方式调整。
```

#### 5. 严重性和预后类问题

当患者询问关于疾病严重性和预后的问题（如"这个病严重吗？"、"会影响视力吗？"）时：

```
关于{{disease_name}}的严重性和预后，请基于患者的检查结果（{{result}}）提供：
1. 当前病情严重程度的客观评估
2. 该疾病的自然病程和可能的进展
3. 及时治疗与否对预后的影响
4. 可能出现的并发症及其预防
5. 长期管理和监测的重要性

保持平衡的态度，既不过度淡化病情，也不引起不必要的恐慌。强调个体差异和积极治疗的价值。
```

### 回答格式模板

标准回答结构：

```
<回答内容，包括：
- 对问题的直接回答
- 相关医学解释
- 实用建议
- 必要的警示或提醒>

<参考资料（如适用）：
- 参考文献或指南名称
- 发布机构
- 年份>
```

### 知识领域限制

模型应限制在以下眼科专业领域内提供答案：
1. 常见眼科疾病的基础知识
2. 眼底疾病的诊断和治疗常识
3. 眼科用药和治疗方案的一般性知识
4. 眼部保健和预防措施
5. 眼科检查和随访的一般性建议

对于超出上述范围的问题，模型应礼貌地表示无法提供专业答案，并建议咨询专业医生。







